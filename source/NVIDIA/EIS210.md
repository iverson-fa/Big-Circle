# EIS210 修改项

## 1 在容器中使用chroot修改根文件目录

```bash
docker container create --name eis200 --hostname docker -v /home/dafa/jetson_flash/r35.3:/root -it ubuntu:20.04 /bin/bash
```

## 2 usb0 - 刷机口的使用

- `hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02-fixed-regulator.dtsi `
- `hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02.dtsi`

第一个文件上电，第二个文件将usb0的role改为host，可以刷机后在OS里验证：

```bash 
cat /sys/devices/platform/3520000.xusb_padctl/usb2-0/usb_role/usb2-0-role-switch/role
```

```shell
diff --git a/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02-fixed-regulator.dtsi b/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02-fixed-regulator.dtsi
index 07ba1b0d8..3724fb0e3 100644
--- a/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02-fixed-regulator.dtsi
+++ b/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02-fixed-regulator.dtsi
@@ -11,7 +11,7 @@
  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
  * more details.
  */
-
+#include <dt-bindings/gpio/tegra234-gpio.h>
 / {
 	fixed-regulators {
 		p3509_vdd_5v_sys: regulator@100 {
@@ -101,5 +101,14 @@
 			vin-supply = <&p3509_vdd_3v3_sys>;
 			regulator-always-on;
 		};
+		p3509_vdd_usb1_5v: regulator@109 {
+			compatible = "regulator-fixed";
+			reg = <109>;
+			regulator-name = "vdd-usb1-5v";
+			regulator-min-microvolt = <5000000>;
+			regulator-max-microvolt = <5000000>;
+			gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(Z, 1) 0>;
+           enable-active-high;
+			regulator-always-on;
+		};
 	};
 };
diff --git a/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02.dtsi b/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02.dtsi
index b6f1047d2..19aa8e899 100644
--- a/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02.dtsi
+++ b/hardware/nvidia/platform/t23x/p3768/kernel-dts/cvb/tegra234-p3509-a02.dtsi
@@ -11,6 +11,7 @@
  * more details.
  */
 #include <dt-bindings/gpio/tegra234-gpio.h>
+#include <dt-bindings/usb/role.h>
 #include "dt-bindings/input/input.h"
 #include "tegra234-p3509-a02-pwm-fan.dtsi"
 #include "tegra234-p3509-a02-pcie.dtsi"
@@ -98,7 +99,7 @@
 					compatible = "usb-b-connector", "gpio-usb-b-connector";
  					label = "micro-USB";
  					type = "micro";
- 					vbus-gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(Z, 1) GPIO_ACTIVE_LOW>;
+					cable-connected-on-boot = <USB_ROLE_HOST>;
  				};
 #endif
 			};
```

其他模组的NVBUG： 3299244(for TX2NX)/2994982(for Xavier NX)/2926573(for Jetson Nano)

## 3 关闭eeprom

- `bootloader/t186ref/BCT/tegra234-mb2-bct-misc-p3767-0000.dts`

```shell
diff --git a/tegra234-mb2-bct-misc-p3767-0000.dts b/tegra234-mb2-bct-misc-p3767-0000.dts
index 6b1f753..ca25286 100644
--- a/tegra234-mb2-bct-misc-p3767-0000.dts
+++ b/tegra234-mb2-bct-misc-p3767-0000.dts
@@ -10,7 +10,7 @@
 			cvm_eeprom_read_size = <0x100>;
 			cvb_eeprom_i2c_instance = <0x0>;
 			cvb_eeprom_i2c_slave_address = <0xae>;
-			cvb_eeprom_read_size = <0x100>;
+			cvb_eeprom_read_size = <0>;
 		};
 	};
 };
```

## 4 创建用户名及自动登陆

```shell
# -u 用户名 -p 密码 -n 用户组
cd Linux_for_Tegra/tools
./l4t_create_default_user.sh -u orin -p 123456a? -n eis200 -a
```

## 5 HDMI

[参考文档](https://big-circle.readthedocs.io/en/latest/NVIDIA/EIS860.html#hdmi)

## 6 rootfs

### 6.1 修改软件源

chroot进入rootfs

```shell
# /etc/apt/sources.list，可不改
deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse
deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse
# 新建/etc/apt/sources.list.d/nvidia-l4t-apt-source.list，不安装jetpack可以不建
deb https://repo.download.nvidia.com/jetson/common r35.3 main
deb https://repo.download.nvidia.com/jetson/t234 r35.3 main
```

### 6.2 安装的软件包

- ntpdate
- netplan.io
- libpam-cracklib

### 6.3 GPIO

- `/sys/class/gpio`

在EIS200（Jetson Nano & Jetson NX）中会生成同名目录，即

```shell
export 341 > export
# 生成gpio341目录，在该目录中操作相关DIO配置
```

在EIS200R中，端口号和目录名对应关系为：

| 面板 | signal name（原理图） | 端口号 | 目录名 |
| ---- | --------------------- | ------ | ------ |
| 0    | GPIO01                | 453    | PQ.05  |
| 1    | GPIO07                | 389    | PG.06  |
| 2    | GPIO10                | 341    | PEE.02 |
| 3    | GPIO09                | 492    | PAC.06 |
| 4    | GPIO11                | 454    | PQ.06  |
| 5    | GPIO05                | 330    | PCC.02 |
| 6    | GPIO13                | 391    | PH.00  |
| 7    | GPIO14                | 465    | PX.03  |

### 6.4 删除多余桌面图标

```bash
# 进入rootfs
rm home/<user_name>/Desktop/nv*.desktop
```

### 6.5 允许ssh使用root用户登陆

```bash
# 进入rootfs
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
```

### 6.6 修改build软链接

```shell
# rootfs/lib/modules/5.10.104-tegra/ 
unlink build
ln -s /usr/src/linux-headers-5.10.104-tegra-ubuntu20.04_aarch64/kernel-5.10/ build
```

### 6.7 修改时间显示格式为CST

```shell
cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime 
```

### 6.8 更改背景图片

替换 `/usr/share/backgrounds` 中的图片。

```shell
mv warty-final-ubuntu.png NVIDIA_Wallpaper.jpg
mv black480.bmp NVIDIA_Login_Logo.png # black480.bmp为纯黑图片
```

### 6.9 RTC

```shell
diff --git a/lib/udev/rules.d/50-udev-default.rules b/lib/udev/rules.d/50-udev-default.rules
index d144a8c..ca9213c 100644
--- a/lib/udev/rules.d/50-udev-default.rules
+++ b/lib/udev/rules.d/50-udev-default.rules
@@ -7,7 +7,7 @@ ACTION=="remove", GOTO="default_end"
 SUBSYSTEM=="virtio-ports", KERNEL=="vport*", ATTR{name}=="?*", SYMLINK+="virtio-ports/$attr{name}"
 
 # select "system RTC" or just use the first one
-SUBSYSTEM=="rtc", ATTR{hctosys}=="1", SYMLINK+="rtc"
+SUBSYSTEM=="rtc", ATTR{hctosys}=="0", SYMLINK+="rtc"
 SUBSYSTEM=="rtc", KERNEL=="rtc0", SYMLINK+="rtc", OPTIONS+="link_priority=-100"
 
 SUBSYSTEM=="usb", ENV{DEVTYPE}=="usb_device", IMPORT{builtin}="usb_id", IMPORT{builtin}="hwdb --subsystem=usb"
```

### 6.10 SPI驱动

```shell
# /etc/modules-load.d/modules.conf
spidev
```

替换音频目录。

### 6.11 IECP

```shell
# /etc/os-release 添加， 非必须
EIS200R_VERSION="1.2"
# /etc/lsb-release 修改
DISTRIB_DESCRIPTION="EIS200R V1.2"
```

## 7 项目定制

### 7.1 修改开机 LOGO

使用 [edk2](https://big-circle.readthedocs.io/en/latest/NVIDIA/Bug.html#edk2uefi) 生成UEFI，注意`bmp`图片位色会影响最后 uefi_Jetson_RELEASE.bin 的大小，经测试，**16位**的图片生成的大小是2.7M，可以正常使用。

### 7.3 固定 eth0 IP

chroot进入rootfs

```shell
$ sudo vim /etc/netpaln/cfg.yaml
# 输入以下内容
network:
    version: 2
    renderer: networkd
    ethernets:
        eth0:
            addresses:
                - 192.168.1.1/24
            gateway4: 192.168.1.1
            nameservers:
                addresses: [114.114.114.114, 8.8.8.8]
$ sudo netplan apply  
```

### 7.4 新安装软件

- docker v20.10.2
- timedatectl
- k8s(kubeadm/kubectl/kubelet) v1.18.9

### 7.5 客户提供文件

```shell
# rootfs
cp <files_path>/yurtclt /usr/local/bin/
cp <files_path>/ibox-release /etc/
```

修改`ibox-release` 中的 `System` 为`20.04`。

### 7.6 拨号驱动及4/5G驱动

**qmi_wwan_q.ko 待测试**

```shell
# 准备好驱动文件dial及编译好的qmi_wwan_q.ko
# rootfs
cp -r <files_path>/dial /opt/MCU/
cp <files_path>/qmi_wwan_q.ko /lib/modules/5.10.104-tegra/kernel/drivers/net/usb/
echo 'qmi_wwan_q.ko' >> /etc/modules
```
