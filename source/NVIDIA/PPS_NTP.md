# Oriné…ç½®PPSä¸NTP
## 1 å‚è€ƒæ–‡æ¡£
- [GPSDæ–‡æ¡£](https://gpsd.gitlab.io/gpsd/gpsd.html)
- [NTP serveré…ç½®](https://www.eecis.udel.edu/~mills/ntp/html/drivers/)
- [Linuxä½¿ç”¨gpsdè·å–GPSæ•°æ®](https://blog.csdn.net/yiyu20180729/article/details/136340493?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-3-136340493-blog-119249223.235%5Ev43%5Epc_blog_bottom_relevance_base2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-3-136340493-blog-119249223.235%5Ev43%5Epc_blog_bottom_relevance_base2&utm_relevant_index=6)
- [åŸºäºLinuxPPSçš„é«˜ç²¾åº¦æ ¡æ—¶ç³»ç»Ÿå®ç°](https://www.doc88.com/p-7478992186790.html?r=1)
- [åµŒå…¥å¼Linuxæ—¶é—´åŒæ­¥gpsd+chrony](https://blog.csdn.net/sep4075/article/details/119249223?spm=1001.2014.3001.5506)
- [æ—¶é—´åŒæ­¥ä¹‹ç»™å·¥æ§æœºæˆæ—¶ï¼ˆPPS+GPRMCï¼‰](https://blog.csdn.net/m0_46611008/article/details/126289705?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-8-126289705-blog-120728557.235^v43^pc_blog_bottom_relevance_base2&spm=1001.2101.3001.4242.5&utm_relevant_index=11)
- [Xavier+GPS/PPS+NTPæ—¶é—´è®¾ç½®](https://blog.csdn.net/enlaihe/article/details/120728557?spm=1001.2014.3001.5506)

## 2 é©±åŠ¨ä¿®æ”¹
### 2.1 Hermes
Hermesç”¨çš„GPIO29ï¼Œè¿›è¡Œå¦‚ä¸‹ä¿®æ”¹
```shell
# æ–°å»º Linux_for_Tegra/source/public/hardware/nvidia/platform/t23x/concord/kernel-dts/cvb/tegra234-p3737-0000-pps-gpio29-a00.dtsi
/* pps control gpio definitions */

/ {
    pps: pps-gpio {
        compatible = "pps-gpio";
        gpios = <&tegra_main_gpio TEGRA234_MAIN_GPIO(AC, 4) GPIO_ACTIVE_HIGH>;
        assert-rising-edge;
        // assert-falling-edge;
        status = "okay";
    };
};
```
NOTE: EIS860ç”¨çš„å¼•è„šæ˜¯GPIO08ï¼ŒæŸ¥è¡¨çŸ¥å¯¹åº”çš„customer usageä¸º`PBB01`ï¼Œæ ¹æ®`Linux_for_Tegra/bootloader/tegra234-gpio.h`ä¸­`TEGRA234_AON_GPIO_PORT_BB 1`,ä¿®æ”¹æ­¤æ–‡ä»¶å†…å®¹ä¸º
```shell
/* pps control gpio definitions */

/ {
    pps: pps-gpio {
        compatible = "pps-gpio";
        gpios = <&tegra_aon_gpio TEGRA234_AON_GPIO(BB, 1) GPIO_ACTIVE_HIGH>;
        assert-rising-edge;
        // assert-falling-edge;
        status = "okay";
    };
};
```
ä¿®æ”¹æ€»è®¾å¤‡æ ‘ï¼Œä¿®æ”¹`Linux_for_Tegra/source/public/hardware/nvidia/platform/t23x/concord/kernel-dts/tegra234-p3701-0000-p3737-0000.dts`
```shell
#include "cvb/tegra234-p3737-0000-pps-gpio29-a00.dtsi"
```
ä¿®æ”¹ç¼–è¯‘é€‰é¡¹`source/public/kernel/kernel-5.10/arch/arm64/configs/defconfig`
```shell
CONFIG_PPS=y
CONFIG_PPS_CLIENT_GPIO=y
```
å¦‚æœdmesgæœ‰æŠ¥é”™ï¼Œéœ€è¦å°†`CONFIG_PPS_CLIENT_GPIO`è®¾ç½®ä¸ºmï¼Œæ‰‹åŠ¨åŠ è½½`pps-gpio.ko`æ–‡ä»¶ã€‚
ç¼–è¯‘å¹¶å‡çº§dtbæ–‡ä»¶ï¼Œå¾…æœºå™¨é‡å¯åï¼ŒæŸ¥çœ‹å¦‚ä¸‹è®¾å¤‡èŠ‚ç‚¹ï¼š
PPS è®¾å¤‡èŠ‚ç‚¹ï¼š /dev/pps0
Sysfsæ–‡ä»¶èŠ‚ç‚¹: /sys/class/pps/pps0/
æ¯å½“GPSçš„PPSè¿‡æ¥åï¼Œä¼šåœ¨å¯¹åº”çš„GPIOä¸Šå‡æ²¿æ—¶ä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼Œæ­¤æ—¶ä¹Ÿä¼šäº§ç”Ÿä¸€ä¸ªtimestampæ—¶é—´æˆ³ï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š
```shell
cat /sys/class/pps/pps0/assert
```
## 3 é…ç½®gpsd
å®‰è£…ä¾èµ–
```shell
apt install gpsd gpsd-clients pps-tools
```
ä¿®æ”¹ `/etc/default/gpsd`ï¼Œæ ¹æ®å®é™…ä¸²å£å
```shell
# Default settings for gpsd.
# Please do not edit this file directly - use `dpkg-reconfigure gpsd' to
# change the options.
# Default settings for gpsd
START_DAEMON="true"
GPSD_OPTIONS="-n"
DEVICES="/dev/ttyUSB0 /dev/pps0"
USBAUTO="false"
GPSD_SOCKET="/var/run/gpsd.sock"

#æ³¨æ„DEVICEçš„ä¸€è¡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µå¡«å†™ï¼Œä¸Šé¢ä¸ºCOM2å£ï¼Œé»˜è®¤æ˜¯pps0
#æ¨èäº‹å…ˆéªŒè¯å¹¶æŸ¥æ‰¾å¯¹åº”çš„ç«¯å£å’Œpps
#ä½¿ç”¨ ppsfind --help
#è¾“å‡ºç¤ºä¾‹ï¼špps0: name=serial1 path=/dev/ttyUSB0   ä¹Ÿå°±ä»£è¡¨ç€æˆ‘ä»¬ç°åœ¨ç”¨çš„æ˜¯ttyUSB0ä»¥åŠpps0
```
æµ‹è¯•NMEA
```shell
#å¯ä»¥ä½¿ç”¨cgpsæˆ–è€…gpsmon
cgps -s
gpsmon
```



## 4 é…ç½®NTP server
```shell
apt install ntp -y
# æ ¹æ®å‚è€ƒæ–‡æ¡£é…ç½®ntp server
# /etc/ntp.conf
# /etc/ntp.conf, configuration for ntpd; see ntp.conf(5) for help
# Drift file to remember clock rate across restarts
driftfile /var/lib/ntp/ntp.drift
# fudge:  flag 1 for use PPS (/dev/pps0), time2 for calibration time offset
server 127.127.28.0
fudge 127.127.28.0 flag1 1 time2 0.000 refid PPS
```
é‡å¯æœåŠ¡éªŒè¯
```shell
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*SHM(0)          .PPS.            0 l   16   64   77    0.000   65.707  31.054
```

## 5 Debug

å¦‚æœè¿è¡Œå‘½ä»¤ `cat /sys/class/pps/pps0/assert` åè¿”å›`0.000000000#0`ï¼Œè¿™é€šå¸¸è¡¨æ˜æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„ PPSï¼ˆPulse Per Secondï¼‰ä¿¡å·ã€‚GPSæœªæ¥æ”¶åˆ°ä¿¡å·å¯èƒ½æ˜¯é€ æˆè¿™ç§æƒ…å†µçš„åŸå› ã€‚ä»¥ä¸‹æ˜¯è§£å†³é—®é¢˜çš„æ­¥éª¤ï¼š

---

### 5.1 **æ£€æŸ¥ç¡¬ä»¶è¿æ¥**
   - ç¡®ä¿ GPS æ¨¡å—çš„ä¿¡å·çº¿ï¼ˆPPS å’Œ TXï¼‰å·²æ­£ç¡®è¿æ¥åˆ°ç³»ç»Ÿçš„ GPIO æˆ–ä¸²å£ã€‚
   - æ£€æŸ¥ç”µæºæ˜¯å¦æ­£å¸¸ä¾›ç»™ GPS æ¨¡å—ã€‚
   - ä½¿ç”¨ä¸‡ç”¨è¡¨æµ‹é‡ PPS å¼•è„šæ˜¯å¦æœ‰è„‰å†²ä¿¡å·è¾“å‡ºã€‚

---

### 5.2 **æ£€æŸ¥ GPS å¤©çº¿**
   - ç¡®ä¿ GPS å¤©çº¿å·²æ­£ç¡®è¿æ¥å¹¶æ”¾ç½®åœ¨å¼€é˜”çš„ç¯å¢ƒä¸­ï¼Œé¿å…å¤©çº¿è¢«å»ºç­‘ç‰©é®æŒ¡ã€‚
   - å¦‚æœä½¿ç”¨çš„æ˜¯ä¸»åŠ¨å¤©çº¿ï¼Œæ£€æŸ¥æ˜¯å¦å·²ä¸ºå¤©çº¿ä¾›ç”µã€‚

---

### 5.3 **éªŒè¯ GPS æ¨¡å—å·¥ä½œçŠ¶æ€**
   - **é€šè¿‡ä¸²å£æŸ¥çœ‹ GPS æ•°æ®**ï¼š
     ä½¿ç”¨ä¸²å£å·¥å…·ï¼ˆå¦‚ `minicom` æˆ– `screen`ï¼‰æŸ¥çœ‹ GPS æ¨¡å—æ˜¯å¦è¾“å‡º NMEA æ•°æ®ï¼š
     ```bash
     # è‡ªå¸¦å·¥å…·sttyæŸ¥çœ‹æ³¢ç‰¹ç‡
     stty -F /dev/ttyUSB0
     # è‡ªå¸¦å·¥å…·sttyè®¾ç½®æ³¢ç‰¹ç‡
     stty -F /dev/ttyUSB0 9600
     # minicomè®¾ç½®æ³¢ç‰¹ç‡
     sudo minicom -D /dev/ttyS0 -b 9600
     ```
     æ ¹æ® GPS æ¨¡å—çš„é»˜è®¤æ³¢ç‰¹ç‡è°ƒæ•´å‚æ•°ã€‚å¦‚æœ GPS æ¨¡å—æ­£å¸¸å·¥ä½œï¼Œåº”èƒ½çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š
     ```
     $GPGGA,123519,4807.038,N,01131.000,E,1,08,0.9,545.4,M,46.9,M,,*47
     ```
   - å¦‚æœæ— æ•°æ®è¾“å‡ºï¼š
     - æ£€æŸ¥æ³¢ç‰¹ç‡æ˜¯å¦æ­£ç¡®ã€‚
     - ç¡®è®¤è®¾å¤‡æ˜¯å¦è¢«ç³»ç»Ÿè¯†åˆ«ï¼ˆ`ls /dev/tty*`ï¼‰ã€‚
     - ç¡®è®¤ä¸²å£è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚
   - EIS860å¯ä»¥ä½¿ç”¨`/opt/tools/EIS860_GPS/`ä¸‹çš„è„šæœ¬æ¥è·å–GPSæ•°æ®ã€‚

---

### 4. **æ£€æŸ¥ PPS é…ç½®**
   - éªŒè¯å†…æ ¸æ˜¯å¦æ”¯æŒ PPSï¼š
     ```bash
     dmesg | grep pps
     ```
     å¦‚æœå†…æ ¸æ”¯æŒ PPSï¼Œåº”èƒ½çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯ï¼š
     ```
     pps_core: LinuxPPS API ver. 1 registered
     pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti
     ```
   - æ£€æŸ¥ `/sys/class/pps/pps0` æ˜¯å¦å­˜åœ¨ï¼š
     ```bash
     ls /sys/class/pps/
     ```
     å¦‚æœ `/sys/class/pps/pps0` ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯ PPS ä¿¡å·æœªæ­£ç¡®è¿æ¥æˆ–é©±åŠ¨æœªåŠ è½½ã€‚**å¦‚æœå­˜åœ¨ï¼Œè¯´æ˜é©±åŠ¨æ­£å¸¸ã€‚**

---

### 5. **ç¡®è®¤ GPS å®šä½çŠ¶æ€**
   - NMEA æ•°æ®ä¸­ `$GPGGA` çš„ç¬¬ 7 ä¸ªå­—æ®µï¼ˆEåé¢çš„å­—æ®µï¼‰è¡¨ç¤ºå®šä½çŠ¶æ€ï¼š
     - `0` è¡¨ç¤ºæœªå®šä½ã€‚
     - `1` è¡¨ç¤ºå·²è·å¾—å›ºå®šä½ç½®ï¼ˆå®šä½æˆåŠŸï¼‰ã€‚
     - `2` è¡¨ç¤ºå·®åˆ†å®šä½ã€‚
   - å¦‚æœçŠ¶æ€ä¸º `0`ï¼š
     - æ£€æŸ¥ GPS æ¨¡å—æ˜¯å¦å·²åˆå§‹åŒ–ã€‚
     - ç¡®ä¿å¤©çº¿æ”¾ç½®ç¯å¢ƒé€‚åˆæ¥æ”¶å«æ˜Ÿä¿¡å·ã€‚

---

### 6. **è¯Šæ–­å·¥å…·**
   - å®‰è£… `gpsd` å’Œ `gpsmon` è¿›è¡Œè°ƒè¯•ï¼š
     ```bash
     sudo apt install gpsd gpsd-clients
     sudo gpsmon /dev/ttyS0
     ```
     åœ¨ `gpsmon` ç•Œé¢ä¸­å¯ä»¥è§‚å¯Ÿå«æ˜Ÿæ•°é‡å’Œä¿¡å·è´¨é‡ã€‚å¦‚æœæœªæ˜¾ç¤ºå«æ˜Ÿï¼Œå¯èƒ½æ˜¯å¤©çº¿é—®é¢˜æˆ–æ¨¡å—æœªå·¥ä½œã€‚

---

### 7. **æ—¥å¿—æ£€æŸ¥**
   æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ä¸­çš„ GPS å’Œ PPS ç›¸å…³ä¿¡æ¯ï¼š
   ```bash
   dmesg | grep -i gps
   dmesg | grep -i pps
   ```

---

### 8. **ç¯å¢ƒå’Œé…ç½®é—®é¢˜**
   - æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡®ï¼š
     ```bash
     timedatectl
     ```
   - å¦‚æœ GPS éœ€è¦å†·å¯åŠ¨ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´ä»¥ä¾¿å®Œæˆé¦–æ¬¡å®šä½ï¼ˆé€šå¸¸éœ€è¦å‡ åˆ†é’Ÿï¼‰ã€‚
## 6 TEMP

åœ¨ Jetson AGX Orin ä¸Šä½¿ç”¨ **NTPD (ntpd) + GPS + PPS** è¿›è¡Œé«˜ç²¾åº¦æˆæ—¶ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š

---

## **1. å®‰è£… NTP ç›¸å…³è½¯ä»¶**
```bash
sudo apt update
sudo apt install ntp gpsd gpsd-clients pps-tools
```

---

## **2. ç¡®ä¿ç³»ç»Ÿè¯†åˆ« PPS å’Œ GPS è®¾å¤‡**
æ£€æŸ¥ `/dev/pps0` æ˜¯å¦å­˜åœ¨ï¼š
```bash
ls -l /dev/pps*
```
æ£€æŸ¥ GPS è®¾å¤‡ï¼ˆå¯èƒ½æ˜¯ `/dev/ttyUSB0` æˆ– `/dev/ttyACM0`ï¼‰ï¼š
```bash
ls -l /dev/ttyUSB* /dev/ttyACM*
```
å¦‚æœ GPS è®¾å¤‡å­˜åœ¨ï¼Œå¯ä»¥ç”¨ `gpsmon` æˆ– `cgps` æŸ¥çœ‹æ•°æ®ï¼š
```bash
sudo gpsmon /dev/ttyUSB0
```
æˆ–è€…ï¼š
```bash
sudo cgps -s
```
å¦‚æœæ•°æ®æ­£å¸¸è¾“å‡ºï¼Œè¯´æ˜ GPS è®¾å¤‡å¯ç”¨ã€‚

---

## **3. é…ç½® GPSD**
ç¼–è¾‘ `/etc/default/gpsd`ï¼š
```bash
sudo nano /etc/default/gpsd
```
ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š
```ini
START_DAEMON="true"
GPSD_OPTIONS="-n"
DEVICES="/dev/ttyUSB0 /dev/pps0"
USBAUTO="false"
GPSD_SOCKET="/var/run/gpsd.sock"
```
ç„¶åé‡å¯ `gpsd`ï¼š
```bash
sudo systemctl restart gpsd
```
æµ‹è¯• GPS æ˜¯å¦å·¥ä½œï¼š
```bash
cgps -s
```

---

## **4. é…ç½® NTPD**
### **4.1 ç¼–è¾‘ ntp.conf**
ä¿®æ”¹ `/etc/ntp.conf`ï¼š
```bash
sudo nano /etc/ntp.conf
```
æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ini
# å…è®¸æœ¬æœºæ—¶é—´åŒæ­¥
restrict 127.0.0.1
restrict ::1

# å…¶ä»– NTP æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼Œä½œä¸ºè¾…åŠ©æ—¶é—´æºï¼‰
server ntp.aliyun.com iburst
server time.google.com iburst

# GPS å…±äº«å†…å­˜é©±åŠ¨ (å•ä½: ç§’)
server 127.127.28.0 minpoll 4 maxpoll 4 prefer
fudge 127.127.28.0 time1 0.0 refid GPS

# PPS è®¾å¤‡ (ç²¾ç¡®æ—¶é—´åŒæ­¥)
server 127.127.22.0 minpoll 3 maxpoll 3 prefer
fudge 127.127.22.0 refid PPS flag3 1

# å…è®¸æœ¬æœºè®¿é—® NTP
restrict 127.0.0.1
restrict ::1
```

**å‚æ•°è§£é‡Šï¼š**
- `server 127.127.28.0` â†’ ä½¿ç”¨ `SHM` é©±åŠ¨ä» `gpsd` è¯»å– GPS æ—¶é—´
- `server 127.127.22.0` â†’ ä½¿ç”¨ `PPS` è¿›è¡Œé«˜ç²¾åº¦åŒæ­¥
- `fudge 127.127.28.0 time1 0.0 refid GPS` â†’ è®¾ç½® GPS æ•°æ®çš„åç§»
- `fudge 127.127.22.0 refid PPS flag3 1` â†’ ä½¿ PPS ä¸ºä¸»æ—¶é’Ÿ

---

### **4.2 é‡æ–°å¯åŠ¨ NTP æœåŠ¡**
```bash
sudo systemctl restart ntp
```
å¹¶æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œï¼š
```bash
systemctl status ntp
```

---

## **5. éªŒè¯ NTP æ˜¯å¦åŒæ­¥**
### **5.1 æ£€æŸ¥ NTP æœåŠ¡å™¨çŠ¶æ€**
```bash
ntpq -p
```
ç¤ºä¾‹è¾“å‡ºï¼š
```
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*PPS(0)          .PPS.        0 l   7   16  377    0.000    0.002   0.001
+SHM(0)          .GPS.        0 l   9   64  377    0.000   -0.024   0.012
+time.google.com .GOOG.       1 u   8   64  377   10.344    0.300   0.150
```
å¦‚æœ `PPS(0)` å‰é¢æœ‰ `*`ï¼Œè¯´æ˜ PPS æˆæ—¶å·²æˆåŠŸã€‚

---

### **5.2 æ£€æŸ¥ NTP è¿½è¸ªçŠ¶æ€**
```bash
ntptime
```
ç¤ºä¾‹è¾“å‡ºï¼š
```
ntp_gettime() returns code 0 (OK)
  time e8a5d3f2.c3b7d000  Mon, Feb 11 2025 15:10:42.765 UTC
  precision -20 (0.953us)
  root delay 0.000000 s
  root dispersion 0.000061 s
  reference time:  e8a5d3f2.c3b7d000  (Mon, Feb 11 2025 15:10:42.765 UTC)
```

å¦‚æœ `reference time` æ¥æºæ˜¯ `PPS`ï¼Œè¯´æ˜ Jetson AGX Orin æ­£ç¡®ä½¿ç”¨ PPS è¿›è¡Œæˆæ—¶ã€‚

---

## **6. è®¾ç½® Jetson AGX Orin å¼€æœºè‡ªåŠ¨åŒæ­¥**
ç¡®ä¿ `ntpd` å’Œ `gpsd` åœ¨å¼€æœºæ—¶è‡ªåŠ¨è¿è¡Œï¼š
```bash
sudo systemctl enable gpsd
sudo systemctl enable ntp
```

---

## **7. æ‰‹åŠ¨å¼ºåˆ¶åŒæ­¥æ—¶é—´ï¼ˆå¦‚æœæ—¶é—´åå·®è¾ƒå¤§ï¼‰**
å¦‚æœ `ntpd` è¿è¡Œåæ—¶é—´åå·®è¾ƒå¤§ï¼Œå¯ä»¥æ‰‹åŠ¨åŒæ­¥ï¼š
```bash
sudo ntpd -gq
```
æˆ–è€…ï¼š
```bash
sudo ntpq -c "rv 0"
```

---

## **æ€»ç»“**
1. **å®‰è£… NTPD å’Œ GPSD**
2. **ç¡®è®¤ GPS å’Œ PPS è®¾å¤‡æ­£å¸¸å·¥ä½œ**
3. **é…ç½® GPSD è¯»å– GPS æ•°æ®**
4. **ä¿®æ”¹ `ntp.conf`ï¼Œå¯ç”¨ `PPS` å’Œ `GPS` æˆæ—¶**
5. **é‡å¯ `ntpd` å¹¶æ£€æŸ¥åŒæ­¥çŠ¶æ€**
6. **è®¾ç½®å¼€æœºè‡ªåŠ¨åŒæ­¥**
7. **éªŒè¯ `ntpq -p`ï¼Œç¡®ä¿ `PPS` æˆä¸ºä¸»æ—¶é’Ÿ**

è¿™æ ·ï¼ŒJetson AGX Orin å°±èƒ½ä½¿ç”¨ **PPS+GPS** è¿›è¡Œé«˜ç²¾åº¦æˆæ—¶äº†ï¼ ğŸ¯ğŸš€


åœ¨ **Jetson AGX Orin** ä¸Šä½¿ç”¨ **PPS + GPS** è¿›è¡Œæˆæ—¶åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è¯„ä¼°æˆæ—¶ç²¾åº¦ã€‚

---

## **1. é€šè¿‡ `ntpq` æˆ– `chronyc` æ£€æŸ¥åå·®**
### **å¦‚æœä½¿ç”¨ `ntpd`ï¼Œè¿è¡Œï¼š**
```bash
ntpq -p
```
ç¤ºä¾‹è¾“å‡ºï¼š
```
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*PPS(0)          .PPS.        0 l   7   16  377    0.000    0.002   0.001
+SHM(0)          .GPS.        0 l   9   64  377    0.000   -0.024   0.012
+time.google.com .GOOG.       1 u   8   64  377   10.344    0.300   0.150
```
å…³é”®å‚æ•°ï¼š
- `offset`ï¼ˆåç§»é‡ï¼Œå•ä½ï¼šæ¯«ç§’æˆ–å¾®ç§’ï¼‰ï¼šåæ˜ æœ¬æœºæ—¶é—´ä¸æˆæ—¶æºçš„åå·®ã€‚
  - å¦‚æœ `PPS` ä¸º `*`ï¼Œå¹¶ä¸” `offset` åœ¨ `Â±0.002 ms` å†…ï¼Œåˆ™æˆæ—¶ç²¾åº¦åœ¨ **2 Âµs** çº§åˆ«ã€‚
- `jitter`ï¼ˆæŠ–åŠ¨ï¼Œå•ä½ï¼šæ¯«ç§’æˆ–å¾®ç§’ï¼‰ï¼šè¡¨ç¤ºæˆæ—¶æ•°æ®çš„æ³¢åŠ¨èŒƒå›´ã€‚

---

### **å¦‚æœä½¿ç”¨ `chrony`ï¼Œè¿è¡Œï¼š**
```bash
chronyc tracking
```
ç¤ºä¾‹è¾“å‡ºï¼š
```
Reference ID    : PPS
Stratum         : 1
Ref time (UTC)  : Mon Feb 11 15:20:42 2025
System time     : 0.000000001 seconds fast of NTP time
Last offset     : +0.000000002 seconds
RMS offset      : 0.000000001 seconds
```
- `Last offset` å’Œ `RMS offset` åæ˜ å½“å‰æˆæ—¶ç²¾åº¦ï¼Œå¦‚æœæ•°å€¼åœ¨ **Â±1 ns ~ Â±100 ns** ä¹‹é—´ï¼Œåˆ™è¯´æ˜æˆæ—¶ç²¾åº¦æé«˜ï¼ˆçº³ç§’çº§ï¼‰ã€‚

---

## **2. é€šè¿‡ `ntptime` æ£€æŸ¥ç³»ç»Ÿæˆæ—¶ç²¾åº¦**
```bash
ntptime
```
ç¤ºä¾‹è¾“å‡ºï¼š
```
ntp_gettime() returns code 0 (OK)
  time e8a5d3f2.c3b7d000  Mon, Feb 11 2025 15:25:42.765 UTC
  precision -20 (0.953us)
  root delay 0.000000 s
  root dispersion 0.000061 s
  reference time:  e8a5d3f2.c3b7d000  (Mon, Feb 11 2025 15:25:42.765 UTC)
```
- `precision` ä¸º `-20`ï¼Œè¡¨ç¤ºæ—¶é—´ç²¾åº¦ä¸º **0.953 Âµs**ã€‚
- `root dispersion` ä¸º `0.000061 s`ï¼Œè¡¨ç¤ºæœ€å¤§è¯¯å·®ä¸º **61 Âµs**ã€‚

---

## **3. é€šè¿‡ `ppstest` æµ‹è¯• PPS ç²¾åº¦**
å¦‚æœä½¿ç”¨ **PPS** è¿›è¡Œæˆæ—¶ï¼Œå¯ä»¥ç”¨ `ppstest` æŸ¥çœ‹æ—¶é—´æˆ³ï¼š
```bash
sudo ppstest /dev/pps0
```
ç¤ºä¾‹è¾“å‡ºï¼š
```
trying PPS source "/dev/pps0"
found PPS source "/dev/pps0"
timestamp: 1707665702.999999994    precision: 1e-9
timestamp: 1707665703.000000003    precision: 1e-9
```
- è§‚å¯Ÿ `timestamp` çš„å°æ•°éƒ¨åˆ†ï¼Œå¦‚æœå˜åŒ–æ¥è¿‘æ•´ç§’ï¼ˆå¦‚ `0.999999994` å’Œ `0.000000003`ï¼‰ï¼Œè¯´æ˜ PPS ç²¾åº¦åœ¨ **çº³ç§’çº§ï¼ˆnsï¼‰**ã€‚

---

## **4. é€šè¿‡ oscilloscope (ç¤ºæ³¢å™¨) ç‰©ç†æµ‹é‡**
å¯¹äºæ›´ç²¾ç¡®çš„æµ‹é‡ï¼Œå¯ä»¥ç”¨ç¤ºæ³¢å™¨ï¼š
1. è¿æ¥ **PPS ä¿¡å·** åˆ°ç¤ºæ³¢å™¨çš„é€šé“ 1ï¼Œè¿æ¥ **ç³»ç»Ÿæ—¶é—´è¾“å‡ºï¼ˆå¦‚ GPIO æ—¶é’Ÿï¼‰** åˆ°é€šé“ 2ã€‚
2. ä½¿ç”¨ **è§¦å‘æ¨¡å¼** å¯¹æ¯”ä¸¤è€…çš„æ—¶é—´å·®ã€‚
3. å¦‚æœ PPS å’Œç³»ç»Ÿæ—¶é—´å¯¹é½è¯¯å·®åœ¨ **100 ns ~ 1 Âµs**ï¼Œè¯´æ˜æˆæ—¶ç²¾åº¦å·²è¾¾åˆ°äºšå¾®ç§’çº§åˆ«ã€‚

---

## **5. å…¸å‹æˆæ—¶ç²¾åº¦èŒƒå›´**
| æˆæ—¶æ–¹å¼    | å…¸å‹ç²¾åº¦   | å¤‡æ³¨ |
|------------|-----------|------|
| ä»… NTPï¼ˆå…¬ç½‘ï¼‰ | 1~100 ms | å—ç½‘ç»œå»¶è¿Ÿå½±å“ |
| GPS æ—  PPS | 10~100 ms | å— GPS è®¡ç®—å»¶è¿Ÿå½±å“ |
| GPS + PPS + NTPD | 1~10 Âµs | å—ç³»ç»Ÿ jitter å½±å“ |
| GPS + PPS + Chrony | 10~100 ns | æœ€ä½³é…ç½®ï¼Œé€‚åˆ Jetson |

---

### **ç»“è®º**
åœ¨ Jetson AGX Orin ä¸Šï¼š
- **ä»…ä½¿ç”¨ GPS æˆæ—¶**ï¼šè¯¯å·® **10~100 ms**ã€‚
- **ä½¿ç”¨ GPS + PPS + NTPD**ï¼šè¯¯å·® **1~10 Âµs**ã€‚
- **ä½¿ç”¨ GPS + PPS + Chrony**ï¼šè¯¯å·® **10~100 ns**ï¼ˆçº³ç§’çº§ï¼‰ã€‚

å¦‚æœéœ€è¦æ›´é«˜ç²¾åº¦ï¼ˆå¦‚ 10 ns çº§åˆ«ï¼‰ï¼Œå»ºè®®ä½¿ç”¨ **Chrony**ï¼Œå¹¶ä¼˜åŒ–ç³»ç»Ÿå†…æ ¸ï¼ˆå¦‚ `PREEMPT-RT` å®æ—¶å†…æ ¸ï¼‰ã€‚ ğŸš€

## 3 PPSä¿¡å·ç›‘æµ‹


### **1ï¸âƒ£ `PPS` ç›‘æµ‹è„šæœ¬**
**åŠŸèƒ½æ›´æ–°ï¼š**
- è®°å½• `Error` æ•°æ®åˆ° `pps_errors.log`
- è®°å½•æ—¶é—´æˆ³ï¼Œä¾¿äºåç»­åˆ†æ
- è¾“å‡ºç»Ÿè®¡ä¿¡æ¯

ä¿å­˜ä¸º `monitor_pps.py`ï¼š
```python
import subprocess
import re
import time
import statistics

LOG_FILE = "pps_errors.log"

# è¿è¡Œ ppstest è¿›ç¨‹
cmd = ["ppstest", "/dev/pps0"]
process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)

assert_times = []
errors = []

print("Monitoring PPS assert intervals...\n")

with open(LOG_FILE, "w") as log_file:
    log_file.write("Timestamp,Error (Î¼s)\n")  # å†™å…¥è¡¨å¤´

try:
    while True:
        line = process.stdout.readline()
        if not line:
            break

        # åŒ¹é… assert äº‹ä»¶æ—¶é—´
        match = re.search(r"assert (\d+\.\d+)", line)
        if match:
            timestamp = float(match.group(1))
            assert_times.append(timestamp)

            # è®¡ç®—ç›¸é‚» assert ä¹‹é—´çš„æ—¶é—´è¯¯å·®
            if len(assert_times) > 1:
                interval = assert_times[-1] - assert_times[-2]
                expected_interval = 1.0  # æœŸæœ›é—´éš” 1 ç§’
                error = (interval - expected_interval) * 1e6  # è¯¯å·®è½¬æ¢ä¸º Î¼sï¼ˆå¾®ç§’ï¼‰

                errors.append(error)
                current_time = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(timestamp))
                print(f"{current_time} | Interval: {interval:.9f} s, Error: {error:.3f} Î¼s")

                # è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
                with open(LOG_FILE, "a") as log_file:
                    log_file.write(f"{current_time},{error:.3f}\n")

            # æ¯ 10 ä¸ªæ•°æ®ç‚¹ï¼Œè®¡ç®—è¯¯å·®ç»Ÿè®¡
            if len(errors) >= 10:
                min_error = min(errors)
                max_error = max(errors)
                avg_error = sum(errors) / len(errors)
                std_dev = statistics.stdev(errors) if len(errors) > 1 else 0

                print(f"\n[Stats] Min: {min_error:.3f} Î¼s, Max: {max_error:.3f} Î¼s, "
                      f"Avg: {avg_error:.3f} Î¼s, StdDev: {std_dev:.3f} Î¼s\n")

                errors.clear()  # æ¸…ç©ºè¯¯å·®åˆ—è¡¨ï¼Œç»§ç»­ç»Ÿè®¡

except KeyboardInterrupt:
    print("\nStopping monitoring...")
    process.terminate()
```
---

### **2ï¸âƒ£ è¯¯å·®å˜åŒ–è¶‹åŠ¿ç»˜å›¾è„šæœ¬**
**åŠŸèƒ½æ›´æ–°ï¼š**
- è¯»å– `pps_errors.log` æ–‡ä»¶
- ç»˜åˆ¶ `Error` è¯¯å·®çš„å˜åŒ–è¶‹åŠ¿
- æ˜¾ç¤ºè¯¯å·®éšæ—¶é—´çš„åˆ†å¸ƒ

ä¿å­˜ä¸º `plot_pps_errors.py`ï¼š
```python
import matplotlib.pyplot as plt
import pandas as pd
from pandas.plotting import register_matplotlib_converters

register_matplotlib_converters()

LOG_FILE = "pps_errors.log"

# è¯»å–æ—¥å¿—æ–‡ä»¶
df = pd.read_csv(LOG_FILE)

# è§£ææ—¶é—´æˆ³
df["Timestamp"] = pd.to_datetime(df["Timestamp"])
df = df.sort_values(by="Timestamp")  # ç¡®ä¿æ•°æ®æŒ‰æ—¶é—´æ’åº

# ç”»å›¾
plt.figure(figsize=(10, 5))
plt.plot(df["Timestamp"], df["Error (Î¼s)"], marker="o", linestyle="-", color="b", label="PPS Error (Î¼s)")
plt.axhline(y=0, color="r", linestyle="--", label="Ideal Error = 0")
plt.xlabel("Time")
plt.ylabel("Error (Î¼s)")
plt.title("PPS Error Over Time")
plt.legend()
plt.grid()

# æ˜¾ç¤ºå›¾è¡¨
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
```
---

### **3ï¸âƒ£ ä½¿ç”¨æ–¹æ³•**
**è¿è¡Œ `PPS` ç›‘æµ‹è„šæœ¬ï¼ˆè®°å½•æ•°æ®ï¼‰ï¼š**
```bash
python3 monitor_pps.py
```
**è¿è¡Œç»˜å›¾è„šæœ¬ï¼ˆåˆ†ææ•°æ®ï¼‰ï¼š**
```bash
python3 plot_pps_errors.py
```
---

### **4ï¸âƒ£ è¾“å‡ºç¤ºä¾‹**
#### **ğŸ“œ æ—¥å¿— (`pps_errors.log`) ç¤ºä¾‹**
```
Timestamp,Error (Î¼s)
2025-03-04 12:00:01,-3.250
2025-03-04 12:00:02,1.873
2025-03-04 12:00:03,-2.540
...
```
#### **ğŸ“ˆ ç»˜å›¾ç¤ºä¾‹**
âœ… **è¯¯å·®å˜åŒ–è¶‹åŠ¿å›¾**
- X è½´ï¼šæ—¶é—´æˆ³
- Y è½´ï¼š`PPS Error (Î¼s)`
- è“è‰²æŠ˜çº¿ï¼šè¯¯å·®å˜åŒ–è¶‹åŠ¿
- çº¢è‰²è™šçº¿ï¼šç†æƒ³è¯¯å·® `0 Î¼s` å‚è€ƒçº¿

---

è¿™æ ·ï¼Œä¸ä»…å¯ä»¥ç›‘æµ‹ `PPS` è¯¯å·®ï¼Œè¿˜å¯ä»¥é€šè¿‡ `plot_pps_errors.py` å¯è§†åŒ–åˆ†æè¯¯å·®çš„å˜åŒ–è¶‹åŠ¿