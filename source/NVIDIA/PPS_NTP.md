# Orin配置PPS与NTP
## 1 参考文档
- [GPSD文档](https://gpsd.gitlab.io/gpsd/gpsd.html)
- [NTP server配置](https://www.eecis.udel.edu/~mills/ntp/html/drivers/)
- [Linux使用gpsd获取GPS数据](https://blog.csdn.net/yiyu20180729/article/details/136340493?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-3-136340493-blog-119249223.235%5Ev43%5Epc_blog_bottom_relevance_base2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-3-136340493-blog-119249223.235%5Ev43%5Epc_blog_bottom_relevance_base2&utm_relevant_index=6)
- [基于LinuxPPS的高精度校时系统实现](https://www.doc88.com/p-7478992186790.html?r=1)
- [嵌入式Linux时间同步gpsd+chrony](https://blog.csdn.net/sep4075/article/details/119249223?spm=1001.2014.3001.5506)
- [时间同步之给工控机授时（PPS+GPRMC）](https://blog.csdn.net/m0_46611008/article/details/126289705?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-8-126289705-blog-120728557.235^v43^pc_blog_bottom_relevance_base2&spm=1001.2101.3001.4242.5&utm_relevant_index=11)
- [Xavier+GPS/PPS+NTP时间设置](https://blog.csdn.net/enlaihe/article/details/120728557?spm=1001.2014.3001.5506)

## 2 驱动修改
### 2.1 Hermes
Hermes用的GPIO29，进行如下修改
```shell
# 新建 Linux_for_Tegra/source/public/hardware/nvidia/platform/t23x/concord/kernel-dts/cvb/tegra234-p3737-0000-pps-gpio29-a00.dtsi
/* pps control gpio definitions */

/ {
    pps: pps-gpio {
        compatible = "pps-gpio";
        gpios = <&tegra_main_gpio TEGRA234_MAIN_GPIO(AC, 4) GPIO_ACTIVE_HIGH>;
        assert-rising-edge;
        // assert-falling-edge;
        status = "okay";
    };
};
```
NOTE: EIS860用的引脚是GPIO08，查表知对应的customer usage为`PBB01`，根据`Linux_for_Tegra/bootloader/tegra234-gpio.h`中`TEGRA234_AON_GPIO_PORT_BB 1`,修改此文件内容为
```shell
/* pps control gpio definitions */

/ {
    pps: pps-gpio {
        compatible = "pps-gpio";
        gpios = <&tegra_aon_gpio TEGRA234_AON_GPIO(BB, 1) GPIO_ACTIVE_HIGH>;
        assert-rising-edge;
        // assert-falling-edge;
        status = "okay";
    };
};
```
修改总设备树，新建`Linux_for_Tegra/source/public/hardware/nvidia/platform/t23x/concord/kernel-dts/tegra234-p3701-0000-p3737-0000.dts`
```shell
#include "cvb/tegra234-p3737-0000-pps-gpio29-a00.dtsi"
```
修改编译选项`source/public/kernel/kernel-5.10/arch/arm64/configs/defconfig`
```shell
CONFIG_PPS=y
CONFIG_PPS_CLIENT_GPIO=y
```
如果dmesg有报错，需要将`CONFIG_PPS_CLIENT_GPIO`设置为m，手动加载`pps-gpio.ko`文件。
编译并升级dtb文件，待机器重启后，查看如下设备节点：
PPS 设备节点： /dev/pps0
Sysfs文件节点: /sys/class/pps/pps0/
每当GPS的PPS过来后，会在对应的GPIO上升沿时会产生一个中断信号，此时也会产生一个timestamp时间戳，通过如下命令查看：
```shell
cat /sys/class/pps/pps0/assert
```
## 3 配置gpsd
安装依赖
```shell
apt install gpsd gpsd-clients pps-tools
```
修改 `/etc/default/gpsd`，根据实际串口名
```shell
# Default settings for gpsd.
# Please do not edit this file directly - use `dpkg-reconfigure gpsd' to
# change the options.
START_DAEMON="true"
GPSD_OPTIONS="-b -n -D1"
DEVICES="/dev/ttyUSB0 /dev/pps0"
USBAUTO="false"
GPSD_SOCKET="/var/run/gpsd.sock"

#注意DEVICE的一行需要根据实际情况填写，上面为COM2口，默认是pps0
#推荐事先验证并查找对应的端口和pps
#使用 ppsfind --help
#输出示例：pps0: name=serial1 path=/dev/ttyUSB0   也就代表着我们现在用的是ttyUSB0以及pps0
```
测试NMEA
```shell
#可以使用cgps或者gpsmon
cgps
gpsmon
```



## 4 配置NTP server
```shell
apt install ntp -y
# 根据参考文档配置ntp server
# /etc/ntp.conf
# /etc/ntp.conf, configuration for ntpd; see ntp.conf(5) for help
# Drift file to remember clock rate across restarts
driftfile /var/lib/ntp/ntp.drift
# fudge:  flag 1 for use PPS (/dev/pps0), time2 for calibration time offset
server 127.127.28.0
fudge 127.127.28.0 flag1 1 time2 0.000 refid PPS
```
重启服务验证
