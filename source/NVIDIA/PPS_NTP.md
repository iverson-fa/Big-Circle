# Orin配置PPS与NTP
## 1 参考文档
- [GPSD文档](https://gpsd.gitlab.io/gpsd/gpsd.html)
- [NTP server配置](https://www.eecis.udel.edu/~mills/ntp/html/drivers/)
- [Linux使用gpsd获取GPS数据](https://blog.csdn.net/yiyu20180729/article/details/136340493?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-3-136340493-blog-119249223.235%5Ev43%5Epc_blog_bottom_relevance_base2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-3-136340493-blog-119249223.235%5Ev43%5Epc_blog_bottom_relevance_base2&utm_relevant_index=6)
- [基于LinuxPPS的高精度校时系统实现](https://www.doc88.com/p-7478992186790.html?r=1)
- [嵌入式Linux时间同步gpsd+chrony](https://blog.csdn.net/sep4075/article/details/119249223?spm=1001.2014.3001.5506)
- [时间同步之给工控机授时（PPS+GPRMC）](https://blog.csdn.net/m0_46611008/article/details/126289705?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-8-126289705-blog-120728557.235^v43^pc_blog_bottom_relevance_base2&spm=1001.2101.3001.4242.5&utm_relevant_index=11)
- [Xavier+GPS/PPS+NTP时间设置](https://blog.csdn.net/enlaihe/article/details/120728557?spm=1001.2014.3001.5506)

## 2 驱动修改
### 2.1 Hermes
Hermes用的GPIO29，进行如下修改
```shell
# 新建 Linux_for_Tegra/source/public/hardware/nvidia/platform/t23x/concord/kernel-dts/cvb/tegra234-p3737-0000-pps-gpio29-a00.dtsi
/* pps control gpio definitions */

/ {
    pps: pps-gpio {
        compatible = "pps-gpio";
        gpios = <&tegra_main_gpio TEGRA234_MAIN_GPIO(AC, 4) GPIO_ACTIVE_HIGH>;
        assert-rising-edge;
        // assert-falling-edge;
        status = "okay";
    };
};
```
NOTE: EIS860用的引脚是GPIO08，查表知对应的customer usage为`PBB01`，根据`Linux_for_Tegra/bootloader/tegra234-gpio.h`中`TEGRA234_AON_GPIO_PORT_BB 1`,修改此文件内容为
```shell
/* pps control gpio definitions */

/ {
    pps: pps-gpio {
        compatible = "pps-gpio";
        gpios = <&tegra_aon_gpio TEGRA234_AON_GPIO(BB, 1) GPIO_ACTIVE_HIGH>;
        assert-rising-edge;
        // assert-falling-edge;
        status = "okay";
    };
};
```
修改总设备树，修改`Linux_for_Tegra/source/public/hardware/nvidia/platform/t23x/concord/kernel-dts/tegra234-p3701-0000-p3737-0000.dts`
```shell
#include "cvb/tegra234-p3737-0000-pps-gpio29-a00.dtsi"
```
修改编译选项`source/public/kernel/kernel-5.10/arch/arm64/configs/defconfig`
```shell
CONFIG_PPS=y
CONFIG_PPS_CLIENT_GPIO=y
```
如果dmesg有报错，需要将`CONFIG_PPS_CLIENT_GPIO`设置为m，手动加载`pps-gpio.ko`文件。
编译并升级dtb文件，待机器重启后，查看如下设备节点：
PPS 设备节点： /dev/pps0
Sysfs文件节点: /sys/class/pps/pps0/
每当GPS的PPS过来后，会在对应的GPIO上升沿时会产生一个中断信号，此时也会产生一个timestamp时间戳，通过如下命令查看：
```shell
cat /sys/class/pps/pps0/assert
```
## 3 配置gpsd
安装依赖
```shell
apt install gpsd gpsd-clients pps-tools
```
修改 `/etc/default/gpsd`，根据实际串口名
```shell
# Default settings for gpsd.
# Please do not edit this file directly - use `dpkg-reconfigure gpsd' to
# change the options.
# Default settings for gpsd
START_DAEMON="true"
GPSD_OPTIONS="-n"
DEVICES="/dev/ttyUSB0 /dev/pps0"
USBAUTO="false"
GPSD_SOCKET="/var/run/gpsd.sock"

#注意DEVICE的一行需要根据实际情况填写，上面为COM2口，默认是pps0
#推荐事先验证并查找对应的端口和pps
#使用 ppsfind --help
#输出示例：pps0: name=serial1 path=/dev/ttyUSB0   也就代表着我们现在用的是ttyUSB0以及pps0
```
测试NMEA
```shell
#可以使用cgps或者gpsmon
cgps -s
gpsmon
```



## 4 配置NTP server
```shell
apt install ntp -y
# 根据参考文档配置ntp server
# /etc/ntp.conf
# /etc/ntp.conf, configuration for ntpd; see ntp.conf(5) for help
# Drift file to remember clock rate across restarts
driftfile /var/lib/ntp/ntp.drift
# fudge:  flag 1 for use PPS (/dev/pps0), time2 for calibration time offset
server 127.127.28.0
fudge 127.127.28.0 flag1 1 time2 0.000 refid PPS
```
重启服务验证
```shell
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*SHM(0)          .PPS.            0 l   16   64   77    0.000   65.707  31.054
```

## 5 Debug

如果运行命令 `cat /sys/class/pps/pps0/assert` 后返回`0.000000000#0`，这通常表明未检测到有效的 PPS（Pulse Per Second）信号。GPS未接收到信号可能是造成这种情况的原因。以下是解决问题的步骤：

---

### 5.1 **检查硬件连接**
   - 确保 GPS 模块的信号线（PPS 和 TX）已正确连接到系统的 GPIO 或串口。
   - 检查电源是否正常供给 GPS 模块。
   - 使用万用表测量 PPS 引脚是否有脉冲信号输出。

---

### 5.2 **检查 GPS 天线**
   - 确保 GPS 天线已正确连接并放置在开阔的环境中，避免天线被建筑物遮挡。
   - 如果使用的是主动天线，检查是否已为天线供电。

---

### 5.3 **验证 GPS 模块工作状态**
   - **通过串口查看 GPS 数据**：
     使用串口工具（如 `minicom` 或 `screen`）查看 GPS 模块是否输出 NMEA 数据：
     ```bash
     # 自带工具stty查看波特率
     stty -F /dev/ttyUSB0
     # 自带工具stty设置波特率
     stty -F /dev/ttyUSB0 9600
     # minicom设置波特率
     sudo minicom -D /dev/ttyS0 -b 9600
     ```
     根据 GPS 模块的默认波特率调整参数。如果 GPS 模块正常工作，应能看到类似以下内容：
     ```
     $GPGGA,123519,4807.038,N,01131.000,E,1,08,0.9,545.4,M,46.9,M,,*47
     ```
   - 如果无数据输出：
     - 检查波特率是否正确。
     - 确认设备是否被系统识别（`ls /dev/tty*`）。
     - 确认串口连接是否正常。
   - EIS860可以使用`/opt/tools/EIS860_GPS/`下的脚本来获取GPS数据。

---

### 4. **检查 PPS 配置**
   - 验证内核是否支持 PPS：
     ```bash
     dmesg | grep pps
     ```
     如果内核支持 PPS，应能看到类似以下信息：
     ```
     pps_core: LinuxPPS API ver. 1 registered
     pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti
     ```
   - 检查 `/sys/class/pps/pps0` 是否存在：
     ```bash
     ls /sys/class/pps/
     ```
     如果 `/sys/class/pps/pps0` 不存在，可能是 PPS 信号未正确连接或驱动未加载。**如果存在，说明驱动正常。**

---

### 5. **确认 GPS 定位状态**
   - NMEA 数据中 `$GPGGA` 的第 7 个字段（E后面的字段）表示定位状态：
     - `0` 表示未定位。
     - `1` 表示已获得固定位置（定位成功）。
     - `2` 表示差分定位。
   - 如果状态为 `0`：
     - 检查 GPS 模块是否已初始化。
     - 确保天线放置环境适合接收卫星信号。

---

### 6. **诊断工具**
   - 安装 `gpsd` 和 `gpsmon` 进行调试：
     ```bash
     sudo apt install gpsd gpsd-clients
     sudo gpsmon /dev/ttyS0
     ```
     在 `gpsmon` 界面中可以观察卫星数量和信号质量。如果未显示卫星，可能是天线问题或模块未工作。

---

### 7. **日志检查**
   查看系统日志中的 GPS 和 PPS 相关信息：
   ```bash
   dmesg | grep -i gps
   dmesg | grep -i pps
   ```

---

### 8. **环境和配置问题**
   - 检查系统时间是否正确：
     ```bash
     timedatectl
     ```
   - 如果 GPS 需要冷启动，等待更长时间以便完成首次定位（通常需要几分钟）。
